<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese doramas</title>
    <link rel="stylesheet" href="style1.css">
</head>
<body>
    <div class="cards-wrapper">
        <!-- <div class="card" data-id="1">
          <img src="https://dorama.land/uploads/generated/serials/1/v1/lyubov-s-pervogo-vzglyada15.jpg?v=4" alt="icon">
          <h4>Любовь с первого взгляда</h4>
          <p>Тань Сюань Лин — новый командующий армией, который лишь недавно был оппозиционером и подвергался преследованию. Теперь же его роль меняется на противоположную — он обретает авторитет и влияние. Однако мужчина чувствует, что его положение все еще шатко и в любой момент направление ветра может измениться.</p>
          <a href="#!" class="link">3.20$</a>
        </div>
        <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/0/v1/vpered-kalmar9.jpg?v=2" alt="icon">
          <h4>Вперёд, Кальмар!</h4>
          <p>Тун Нянь - 19-летняя студентка-отличница с высоким IQ, но низким эмоциональным интеллектом EQ, которая также известна в мире аниме-косплея и хорошо поёт.</p>
          <a href="#!" class="link">14.99$</a>
        </div>
        <div class="card" data-id="1">
          <img src="https://dorama.land/uploads/generated/serials/0/v1/sad-padayuschih-zvezd1.jpg?v=1" alt="icon">
          <h4>Сад падающих звёзд</h4>
          <p>В центре сюжета Шань Цей — симпатичная, милая и добрая девушка из бедной семьи. Благодаря упорному труду и хорошим оценкам ей удается поступить в престижный вуз, где учатся дети богатых и влиятельных родителей. </p>
          <a href="#!" class="link">3.20$</a>
        </div>
        <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/0/v1/arsenal-voennoy-akademii.jpg?v=4" alt="icon">
          <h4>Арсенал военной академии</h4>
          <p>Действия происходят в 1911 году, когда началась Революция и правительство Цин пришло в упадок. Нация страдала от политических баталий, а народ был запуган.</p>
          <a href="#!" class="link">9$</a>
        </div>
        <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/1/v1/gorod-struyashchegosya-sveta.jpg?v=1" alt="icon">
          <h4>Город струящегося света</h4>
          <p>Действие происходит на берегах Шанхая в начале 20-го века, где военачальники начинают захватывать власть, появляется много героев, и поднимаются революционные движения. Богатая и влиятельная семья Жун часто злоупотребляла своими полномочиями для совершения ужасных преступлений.</p>
          <a href="#!" class="link">4.20$</a>
        </div>
        <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/1/v1/okazyvaetsya-ya-ochen-silno-tebya-lyublyu3.jpg?v=1" alt="icon">
          <h4>Оказывается, я очень сильно тебя люблю</h4>
          <p>Сан У Янь является фанаткой таинственного автора песен по имени И Цзинь. Молодой композитор долгие годы скрывает личность, но неожиданно решает дать интервью. К сожалению, прямо перед этим Сан У Янь приходится вернуться в университет, и ей не удается встретиться лицом к лицу с мужчиной её мечты… </p>
          <a href="#!" class="link">6$</a>
        </div>
        <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/0/v1/detektiv-el.jpg?v=1" alt="icon">
          <h4>Детектив Эл</h4>
          <p>Талантливый детектив Ло Фей обладает высоким IQ, проницательностью и дотошностью, поэтому всегда находит улики и может разглядеть самые незначительные детали, которые становятся ключевыми доказательствами в расследуемом деле. Его услугами пользуются многие полицейские участки, которые без его помощи не могут выйти на след преступника. </p>
          <a href="#!" class="link">4.50$</a>
        </div>
      <div class="card">
          <img src="https://dorama.land/uploads/generated/serials/0/v1/sudmedekspert-cin-min.jpg?v=1" alt="icon">
          <h4>Судмедэксперт Цинь Мин</h4>
          <p>Цинь Мин скептически относится к девушке, решая, что она, как и другие, сбежит от него через пару недель. Но Да Бао показывает себя с неожиданной стороны. Она спокойно и рассудительно ведет себя при виде страшно искалеченных трупов, а еще обладает потрясающей наблюдательностью и чутким обонянием.</p>
          <a href="#!" class="link">4.50$</a>
        </div> -->
      </div>
      

      <script>
        let goods = (localStorage.getItem('korzina'))? JSON.parse(localStorage.getItem('korzina')) : [];
        console.log(goods);

        let query = fetch("https://637eed1a5b1cc8d6f936c37d.mockapi.io/category/2/films")
            .then(responce => responce.json())
            .then(json => {
              console.log(json);
              json.forEach(element => {
                let card = document.createElement('div');
                card.classList.add('card')
                card.dataset.id = element.id;
                card.innerHTML = `
                <h4>${element.name}</h4>
                <img src="${element.img}" alt="icon">
                <p>${element.discription}</p>
                <a href="#!" class="link">${element.price}$</a>`;
                document.querySelector('.cards-wrapper').append(card);
              }); 
              
              document.querySelectorAll('.link').forEach(element => {
                element.addEventListener('click',  function (elem){
                  if (goods[element.closest('.card').dataset.id-1]) {
                    goods[element.closest('.card').dataset.id - 1].count++;
                  } else {
                    goods[element.closest('.card').dataset.id - 1] = {
                      id: element.closest('.card').dataset.id,
                      price: element.closest('.card').querySelector('.link').innerText,
                      name: element.closest('.card').querySelector('h4').innerText,
                      count: 1
                    };
                  }
                  localStorage.setItem('korzina', JSON.stringify(goods));
                  console.log(goods)
                });
              })
              
            });

            
            calc_sum();

            console.log(goods);

            function decrement(e) {
            const btn = e.target.parentNode.parentElement.querySelector(
              'button[data-action="decrement"]'
            );
            const target = btn.nextElementSibling;
            let value = Number(target.value);
            value--;
            value = (value < 0)? 0: value;
            target.value = value;
          }
      
            function increment(e) {
            const btn = e.target.parentNode.parentElement.querySelector(
              'button[data-action="decrement"]'
             );
            const target = btn.nextElementSibling;
            let value = Number(target.value);
            value++;
            target.value = value;
          }
      
            const decrementButtons = document.querySelectorAll(
              `button[data-action="decrement"]`
            );
      
            const incrementButtons = document.querySelectorAll(
              `button[data-action="increment"]`
            );
      
            decrementButtons.forEach(btn => {
              btn.addEventListener("click", decrement);
            });
      
            incrementButtons.forEach(btn => {
              btn.addEventListener("click", increment);
             });

        let delete_card = document.querySelectorAll('.remove-icon img');

        function calc_sum() {
          let sum = 0;
          let length = 0;
          goods.forEach(element => {
            if (element) {
              sum += element.price * element.count;
              length++;
            }
          })
          // console.log(price)
          document.querySelector('.h1 span').innerHTML = '(' + length + ')';
          document.querySelector('.price').innerHTML = sum;
        }

        delete_card.forEach(element => {
          element.addEventListener('click', function () {
            let parent = this.closest('.card');
            console.log(parent.dataset.id);
            goods[parent.dataset.id] = null;
            localStorage.setItem('korzina', JSON.stringify(goods));
            parent.parentNode.removeChild(parent);
            calc_sum();
          });
        })
      </script>
</body>
</html>